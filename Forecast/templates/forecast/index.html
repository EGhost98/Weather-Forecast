{% extends 'forecast/base.html' %}
{% load custom_filters %}
{% block title %}Weather Forecast App{% endblock %}
{% block content %}
    <div class="row">
        <div class="column">
            <div class="container mt-5">
                <form action="" method="post" class="form-inline mb-3 fadeIn">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="input-group">{{ form.latitude }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="input-group">{{ form.longitude }}</div>
                        </div>
                        <div class="col-12 mb-3">{{ form.detail }}</div>
                        <div class="col-12">
                            <button class="btn btn-success w-100" type="submit">Forecast</button>
                        </div>
                    </div>
                    {% if form.errors %}
                        <div class="alert alert-danger mt-4" role="alert">
                            <p>{{ errors }}</p>
                        </div>
                    {% endif %}
                </form>
                {% if detail == "current" %}
                    <div class="card" style="width: 18rem">
                        <div class="card-body">
                            <h5 class="card-text">{{ Weather_Data.dt|unix_to_datetime }}</h5>
                            <p class="card-text">{{ Weather_Data.weather.0.description }}</p>
                            <p class="card-text">Temperature: {{ Weather_Data.main.temp|kev_cel }} 째C</p>
                            <p class="card-text">Feels like: {{ Weather_Data.main.feels_like|kev_cel }} 째C</p>
                            <p class="card-text">Humidity: {{ Weather_Data.main.humidity }}%</p>
                            <p class="card-text">Wind Speed: {{ Weather_Data.wind.speed }} m/s</p>
                            {% if Weather_Data.rain %}<p class="card-text">RainFall (1h): {{ Weather_Data.rain.1h }} m/s</p>{% endif %}
                        </div>
                    </div>
                {% else %}
                    {% for item in Weather_Data.list|slice:":7" %}
                        <div class="card mb-3" style="max-width: 18rem">
                            <div class="card-body">
                                <h5 class="card-title">{{ item.dt_txt }}</h5>
                                <p class="card-text">{{ item.weather.0.description }}</p>
                                <h6 class="card-subtitle mb-2 text-muted">Temperature: {{ item.main.temp|kev_cel }}째C</h6>
                                <p class="card-text">Feels like: {{ item.main.feels_like|kev_cel }}째C</p>
                                <p class="card-text">Humidity: {{ item.main.humidity }}%</p>
                                <p class="card-text">Wind Speed: {{ item.wind.speed }} m/s</p>
                                {% if item.rain.3h %}<p class="card-text">Rainfall (3h): {{ item.rain.3h }} mm</p>{% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        <div class="column">
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Weather Forecast Data (Raw JSON)</h5>
                    </div>
                    <div class="column">
                        <pre><code id="Weather" class="json"></code></pre>
                        <button class="btn btn-primary" id="downloadButton">Weather Forecast Data (Raw JSON)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        .card.clear {
            background-image: url('path_to_clear_image.jpg');
        }

        .card.clouds {
            background-image: url('path_to_clouds_image.jpg');
        }

        .card.rain {
            background-image: url('path_to_rain_image.jpg');
        }

        .row {
            display: flex;
            flex-direction: row;
            width: 100%;
            padding-bottom: 1rem;
        }

        .column {
            flex-basis: 50%;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
        }

        .column figure {
            padding: 0px 12px;
        }

        pre {
            background-color: #f3f3f3;
            padding: 1rem;
            overflow-x: auto;
        }
    </style>
    <script>
        const Wea_Data = JSON.parse("{{ raw_json|escapejs }}");
        let pretty_json = JSON.stringify(Wea_Data, null, 2);
        document.getElementById("Weather").innerHTML = pretty_json;

        // Function to download the JSON file
        function downloadJSON(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Attach click event listener to the download button
        document.getElementById("downloadButton").addEventListener("click", function () {
            downloadJSON("weather_forecast.json", JSON.stringify(Wea_Data, null, 2));
        });
    </script>

{% endblock %}
