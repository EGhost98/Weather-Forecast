{% extends 'forecast/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Weather Forecast App{% endblock %}
{% block content %}
    <div class="container mt-5">
        <form action="" method="post" class="form-inline mb-3 fadeIn">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="input-group">{{ form.latitude }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">{{ form.longitude }}</div>
                </div>
                <div class="col-12 mb-3">{{ form.detail }}</div>
                <div class="col-12">
                    <button class="btn btn-success w-100" type="submit">Forecast</button>
                </div>
            </div>
            {% if errors %}
                <div class="alert alert-danger mt-4" role="alert">
                    <p>{{ errors }}</p>
                </div>
            {% endif %}
        </form>
        {% if Weather_Data %}
        <button class="btn btn-primary" id="downloadButton">
            <i class="fas fa-download"></i> Weather Forecast Data (Raw JSON)
          </button>          
{% endif %}
    </div>
    <br><br><br><br><br><br><br><br>
{% if detail == "current" %}
    <div class="forecast-table">
            <div class="forecast-container1">
                <div class="today forecast">
                    <div class="forecast-header">
                        <div class="day">{{ Weather_Data.dt|unix_to_datetime }}</div>
                        <div class="date">{% now "l" %}</div>
                    </div>
                    <!-- .forecast-header -->
                    <div class="forecast-content">
                        <div class="location">{{ Weather_Data.name }},{{ Weather_Data.sys.country }}</div>
                        <div class="degree">
                            <div class="num">
                                {{ Weather_Data.main.temp|kev_cel }}<sup>o</sup>C
                            </div>
                            <div class="forecast-icon">
                                <img src="http://openweathermap.org/img/wn/{{ Weather_Data.weather.icon }}@2x.png"
                                     alt=""
                                     width="90">
                            </div>
                        </div>
                        <span>
                            <img style="height: 25px;
                                        width: 25px"
                                 src="{% static 'images/cloud.png' %}"
                                 alt="">
                        {{ Weather_Data.clouds.all }}%</span>
                        <span>
                            <img src="{% static 'images/icon-wind.png' %}" alt="">
                        {{ Weather_Data.wind.speed }}km/h</span>
                        <span>
                            <img src="{% static 'images/icon-compass.png' %}" alt="degree">
                        {{ Weather_Data.wind.deg }}<sup> o</sup></span>
                        <span>
                            <img style="height: 25px;
                                        width: 25px"
                                 src="{% static 'images/hot.png' %}"
                                 alt="status">
                        {{ Weather_Data.weather.0.description|capfirst }}</span>
                    </div>
                </div>
            </div>
    </div>
{% elif Weather_Data %}
    <div class="forecast-table">
            <div class="forecast-container">
                <div class="today forecast">
                    <div class="forecast-header">
                        <div class="day">{{ Weather_Data.list.0.dt|unix_to_datetime }}</div>
                        <div class="date">{% now "l" %}</div>
                    </div>
                    <!-- .forecast-header -->
                    <div class="forecast-content">
                        <div class="location">{{ Weather_Data.city.name }},{{ Weather_Data.city.country }}</div>
                        <div class="degree">
                            <div class="num">
                                {{ Weather_Data.list.0.main.temp|kev_cel }}<sup>o</sup>C
                            </div>
                            <div class="forecast-icon">
                                <img src="http://openweathermap.org/img/wn/{{ Weather_Data.list.0.weather.0.icon }}@2x.png"
                                    alt=""
                                    width="90">
                            </div>
                        </div>
                        <span>
                            <img style="height: 25px;
                                        width: 25px"
                                src="{% static 'images/cloud.png' %}"
                                alt="">
                        {{ Weather_Data.list.0.clouds.all }}%</span>
                        <span>
                            <img src="{% static 'images/icon-wind.png' %}" alt="">
                        {{ Weather_Data.list.0.wind.speed }}km/h</span>
                        <span>
                            <img src="{% static 'images/icon-compass.png' %}" alt="degree">
                        {{ Weather_Data.list.0.wind.deg }}<sup> o</sup></span>
                        <span>
                            <img style="height: 25px;
                                        width: 25px"
                                src="{% static 'images/hot.png' %}"
                                alt="status">
                        {{ Weather_Data.list.0.weather.0.description|capfirst }}</span>
                    </div>
                </div>
                {% for item in Weather_Data.list|slice:"1:7" %}
                    <div class="forecast">
                        <div class="forecast-header">
                            <div class="day">{{ item.dt_txt }}</div>
                        </div>
                        <div class="forecast-content">
                            <div class="forecast-icon">
                                <img src="http://openweathermap.org/img/wn/{{ item.weather.0.icon }}@2x.png"
                                    alt=""
                                    width="48">
                            </div>
                            <div class="degree">
                                {{ item.main.temp_max|kev_cel }}<sup>o</sup>C
                            </div>
                            <small>{{ item.main.temp_min|kev_cel }}<sup>o</sup></small>
                        </div>
                    </div>
                {% endfor %}
            </div>
    </div>
{% endif %}

<script>
    const Wea_Data = JSON.parse("{{ raw_json|escapejs }}");
    let pretty_json = JSON.stringify(Wea_Data, null, 2);
    {% comment %} document.getElementById("Weather").innerHTML = pretty_json; {% endcomment %}

    // Function to download the JSON file
    function downloadJSON(filename, text) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // Attach click event listener to the download button
    document.getElementById("downloadButton").addEventListener("click", function() {
        downloadJSON("weather_forecast.json", JSON.stringify(Wea_Data, null, 2));
    });
</script>
{% endblock %}
